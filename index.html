<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Count Final Description</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Cairo', sans-serif; } 
        .error-glow { box-shadow: 0 0 5px red; border-color: red !important; background-color: #fff5f5; }
        @media print { .no-print { display: none; } body { background: white; } }
        /* Modal Overlay Animation */
        .modal-overlay { background-color: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; }
        .audit-log { white-space: pre-wrap; direction: rtl; font-size: 11px; color: #444; line-height: 1.6; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const APP_PIN = "1234";

        // --- Icons Helper ---
        const Icon = ({ name, size = 18, className, onClick }) => {
            const iconRef = React.useRef(null);
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons({ root: iconRef.current, name, attrs: { width: size, height: size, class: className } }); }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className} onClick={onClick}></i>;
        };
        const Icons = { Lock: p=><Icon name="lock" {...p}/>, Unlock: p=><Icon name="unlock" {...p}/>, Calculator: p=><Icon name="calculator" {...p}/>, Wallet: p=><Icon name="wallet" {...p}/>, RefreshCcw: p=><Icon name="refresh-ccw" {...p}/>, Coins: p=><Icon name="coins" {...p}/>, User: p=><Icon name="user" {...p}/>, AlertTriangle: p=><Icon name="alert-triangle" {...p}/>, Download: p=><Icon name="download" {...p}/>, Upload: p=><Icon name="upload" {...p}/>, FileSpreadsheet: p=><Icon name="file-spreadsheet" {...p}/>, Save: p=><Icon name="save" {...p}/>, Printer: p=><Icon name="printer" {...p}/>, Trash2: p=><Icon name="trash-2" {...p}/>, Plus: p=><Icon name="plus" {...p}/>, ArrowDown: p=><Icon name="arrow-down-circle" {...p}/>, ArrowUp: p=><Icon name="arrow-up-circle" {...p}/>, X: p=><Icon name="x" {...p}/>, Check: p=><Icon name="check-circle" {...p}/>, Eye: p=><Icon name="eye" {...p}/>, Edit: p=><Icon name="edit" {...p}/>, Ban: p=><Icon name="ban" {...p}/>, RefreshCw: p=><Icon name="refresh-cw" {...p}/>, Layers: p=><Icon name="layers" {...p}/>, XCircle: p=><Icon name="x-circle" {...p}/> };

        const { useState, useEffect, useRef } = React;
        
        const CURRENCIES = { 
            EGP: { name: 'Ø¬ÙÙÙ ÙØµØ±Ù', symbol: 'EGP', denominations: [200, 100, 50, 20, 10, 5, 1, 0.5, 0.25, 0.01] },
            USD: { name: 'Ø¯ÙÙØ§Ø± Ø£ÙØ±ÙÙÙ', symbol: 'USD', denominations: [100, 50, 20, 10, 5, 2, 1] }, 
            EUR: { name: 'ÙÙØ±Ù', symbol: 'EUR', denominations: [500, 200, 100, 50, 20, 10, 5] }, 
            SAR: { name: 'Ø±ÙØ§Ù Ø³Ø¹ÙØ¯Ù', symbol: 'SAR', denominations: [500, 100, 50, 10, 5, 1] } 
        };
        const SYSTEM_DENOMS = [100, 10, 5, 1, 0.5, 0.25, 0.01]; 

        const fmtCurr = (a, c='EGP') => new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 2 }).format(a) + ' ' + c;
        const fmtNum = (n) => (!n && n!==0) ? '' : new Intl.NumberFormat('en-US').format(n);
        const fmtDate = (d) => new Date(d).toLocaleString('en-EG', { hour12: true });
        const sortDenoms = (obj) => Object.entries(obj).sort((a,b) => parseFloat(b[0]) - parseFloat(a[0]));

        // --- UPDATED: Human Readable Audit Log ---
        const generateDetailedAudit = (oldData, newData, oldNotes) => {
            let changes = [];
            // Helper for 5*200 format
            const fmtCount = (c, d) => `${c}*${d}`;

            // Compare Cash In
            const allIn = new Set([...Object.keys(oldData.cashInBreakdown), ...Object.keys(newData.cashInBreakdown)]);
            allIn.forEach(d => {
                const oldV = oldData.cashInBreakdown[d] || 0;
                const newV = newData.cashInBreakdown[d] || 0;
                if(oldV !== newV) {
                    changes.push(`ØªØ¹Ø¯ÙÙ ÙØ§Ø±Ø¯ ÙØ¦Ø© ${d}: ÙÙ (${fmtCount(oldV, d)}) Ø¥ÙÙ (${fmtCount(newV, d)})`);
                }
            });

            // Compare Cash Out
            const allOut = new Set([...Object.keys(oldData.cashOutBreakdown), ...Object.keys(newData.cashOutBreakdown)]);
            allOut.forEach(d => {
                const oldV = oldData.cashOutBreakdown[d] || 0;
                const newV = newData.cashOutBreakdown[d] || 0;
                if(oldV !== newV) {
                    changes.push(`ØªØ¹Ø¯ÙÙ Ø®Ø§Ø±Ø¬ ÙØ¦Ø© ${d}: ÙÙ (${fmtCount(oldV, d)}) Ø¥ÙÙ (${fmtCount(newV, d)})`);
                }
            });

            // Totals
            if(oldData.totalChecks !== newData.totalChecks) {
                changes.push(`ØªØ¹Ø¯ÙÙ Ø¥Ø¬ÙØ§ÙÙ Ø§ÙØ´ÙÙØ§Øª: ÙÙ ${fmtNum(oldData.totalChecks)} Ø¥ÙÙ ${fmtNum(newData.totalChecks)}`);
            }
            if(oldData.totalDepositsRequired !== newData.totalDepositsRequired) {
                changes.push(`ØªØ¹Ø¯ÙÙ Ø¥Ø¬ÙØ§ÙÙ Ø§ÙØ¥ÙØ¯Ø§Ø¹Ø§Øª: ÙÙ ${fmtNum(oldData.totalDepositsRequired)} Ø¥ÙÙ ${fmtNum(newData.totalDepositsRequired)}`);
            }

            const timestamp = new Date().toLocaleTimeString('en-EG', {hour12:true, hour:'2-digit', minute:'2-digit'});
            const newEntry = `[${timestamp}] ` + (changes.length > 0 ? changes.join(" | ") : "ØªÙ Ø§ÙØ­ÙØ¸ Ø¨Ø¯ÙÙ ØªØºÙÙØ±Ø§Øª ÙÙ Ø§ÙÙÙÙ");
            return oldNotes ? `${oldNotes}\n${newEntry}` : newEntry;
        };

        const openPrint = (data) => {
            const w = window.open('', '_blank', 'width=900,height=800');
            if(!w) return alert("Ø§Ø³ÙØ­ Ø¨Ø§ÙÙÙØ§ÙØ° Ø§ÙÙÙØ¨Ø«ÙØ©");
            
            let title="Ø¥ÙØµØ§Ù ÙØ¹Ø§ÙÙØ©", lbl="Ø¹ÙÙÙ", clr="#000";
            if(data.type==='CASH_IN'){title="Ø¥ÙØµØ§Ù Ø§Ø³ØªÙØ§Ù ÙÙØ¯ÙØ©";lbl="Cash In";clr="green";}
            else if(data.type==='CASH_OUT'){title="Ø¥ÙØµØ§Ù Ø¥Ø®Ø±Ø§Ø¬ ÙÙØ¯ÙØ©";lbl="Cash Out";clr="orange";}
            else if(data.type==='EXCHANGE'){title="Ø¥ÙØµØ§Ù ØªØºÙÙØ± ÙØ¦Ø§Øª";lbl="Exchange";clr="blue";}
            else if(data.type==='MULTI'){title="Ø¥ÙØ¯Ø§Ø¹Ø§Øª ÙØªØ¹Ø¯Ø¯Ø©";lbl="Multi-Deposit";clr="purple";}
            
            let statusBadge = "";
            if(data.status === "VOID") statusBadge = "<span style='color:red;border:2px solid red;padding:5px;transform:rotate(-15deg);display:inline-block;font-size:20px'>ÙÙØºØ§Ø© (VOID)</span>";
            else if(data.auditNotes) statusBadge = "<span style='color:blue;border:2px solid blue;padding:2px 5px;'>ÙØ¹Ø¯ÙØ© (Edited)</span>";

            const html = `<!DOCTYPE html><html dir="rtl" lang="ar"><head><title>Print #${data.id}</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Cairo';padding:40px}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #000;padding:8px;text-align:center}th{background:#eee}.box{border:2px solid #000;padding:15px;text-align:center;margin:20px 0;font-weight:bold}.footer{display:flex;justify-content:space-between;margin-top:50px}</style></head><body>
            <h1 style="text-align:center;border-bottom:3px solid #000;padding-bottom:10px">${title} ${statusBadge}</h1>
            <div style="background:#f9f9f9;padding:10px;border:1px solid #000;display:flex;justify-content:space-between;font-weight:bold"><span>Ø±ÙÙ: ${data.id || 'ÙØ³ÙØ¯Ø©'}</span><span>${data.date ? fmtDate(data.date) : new Date().toLocaleString('en-EG')}</span><span style="color:${clr}">${lbl}</span></div>
            <h3>Ø§ÙÙÙØ®Øµ (${data.currency})</h3>
            <table><tr><th>Ø§ÙØ¨ÙØ§Ù</th><th>Ø§ÙÙÙÙØ©</th></tr>
            ${data.type==='EXCHANGE' ? `<tr><td>Ø§ÙÙØ¨ÙØº Ø§ÙÙØºÙØ±</td><td>${fmtCurr(data.totalCashIn, data.currency)}</td></tr>` : 
            `${data.type!=='CASH_IN'?`<tr><td style="text-align:right">Ø¥Ø¬ÙØ§ÙÙ Ø§ÙØ®Ø§Ø±Ø¬ (Out)</td><td>${fmtCurr(data.totalCashOut,data.currency)}</td></tr>`:''}
            ${data.type!=='CASH_OUT'?`<tr><td style="text-align:right">Ø¥Ø¬ÙØ§ÙÙ Ø§ÙÙØ³ØªÙÙ (In)</td><td>${fmtCurr(data.totalCashIn,data.currency)}</td></tr>`:''}
            ${(data.type==='CUSTOMER' || data.type==='MULTI')?`<tr><td style="text-align:right">Ø§ÙØ´ÙÙØ§Øª</td><td>${fmtCurr(data.totalChecks,data.currency)}</td></tr><tr><td style="text-align:right">Ø§ÙÙØ·ÙÙØ¨ (Slips)</td><td>${fmtCurr(data.totalDepositsRequired,data.currency)}</td></tr>`:''}`}
            </table>
            ${(data.type==='CUSTOMER' || data.type==='MULTI')?`<div class="box">Ø§ÙÙØ±Ù: ${fmtCurr(data.variance,data.currency)}<br/><small>${Math.abs(data.variance)<0.01?'â ÙØªØ·Ø§Ø¨ÙØ©':data.variance>0?'â ï¸ Ø²ÙØ§Ø¯Ø©':'â Ø¹Ø¬Ø²'}</small></div>`:''}
            ${data.type === 'MULTI' && data.systemBreakdown ? `<h4>Ø§ÙÙØ¦Ø§Øª Ø§ÙÙØ·ÙÙØ¨Ø© ÙÙØ³ÙØ³ØªÙ (Fake Breakdown)</h4><div style="font-size:12px; border:1px dashed #000; padding:10px; margin-bottom:15px">${Object.entries(data.systemBreakdown).sort((a,b)=>b[0]-a[0]).map(([d,c]) => `[${d}: ${c}]`).join(' - ')}</div>` : ''}
            ${data.totalCashIn>0?`<h4>ØªÙØ§ØµÙÙ Ø§ÙÙØ§Ø±Ø¯ (In)</h4><table><thead><tr><th>Ø§ÙÙØ¦Ø©</th><th>Ø§ÙØ¹Ø¯Ø¯</th><th>Ø§ÙÙÙÙØ©</th></tr></thead><tbody>${sortDenoms(data.cashInBreakdown).map(([d,c])=>c>0?`<tr><td>${d}</td><td>${c}</td><td>${fmtNum(c*d)}</td></tr>`:'').join('')}</tbody></table>`:''}
            ${data.totalCashOut>0?`<h4>ØªÙØ§ØµÙÙ Ø§ÙØ®Ø§Ø±Ø¬ (Out)</h4><table><thead><tr><th>Ø§ÙÙØ¦Ø©</th><th>Ø§ÙØ¹Ø¯Ø¯</th><th>Ø§ÙÙÙÙØ©</th></tr></thead><tbody>${sortDenoms(data.cashOutBreakdown).map(([d,c])=>c>0?`<tr><td>${d}</td><td>${c}</td><td>${fmtNum(c*d)}</td></tr>`:'').join('')}</tbody></table>`:''}
            ${data.checks?.length>0?`<h4>Ø§ÙØ´ÙÙØ§Øª</h4><ul>${data.checks.map(c=>`<li>${fmtNum(c.amount)}</li>`).join('')}</ul>`:''}
            ${data.deposits?.length>0?`<h4>Ø§ÙØ¥ÙØ¯Ø§Ø¹Ø§Øª</h4><ul>${data.deposits.map(d=>`<li>${fmtNum(d.amount)}</li>`).join('')}</ul>`:''}
            <div class="footer"><div>Ø§ÙØªÙÙØ±: ${data.tellerName}</div><div>Ø§ÙÙØ±Ø§Ø¬Ø¹: .................</div></div>
            <script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script></body></html>`;
            w.document.write(html); w.document.close();
        };

        // --- Custom Confirm Modal ---
        const ConfirmModal = ({ message, onConfirm, onCancel }) => (
            <div className="modal-overlay">
                <div className="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                    <Icons.AlertTriangle size={48} className="mx-auto text-yellow-500 mb-4"/>
                    <h3 className="font-bold text-lg mb-2">ØªØ£ÙÙØ¯ Ø§ÙØ¥Ø¬Ø±Ø§Ø¡</h3>
                    <p className="text-gray-600 mb-6 text-sm whitespace-pre-line">{message}</p>
                    <div className="flex gap-2 justify-center">
                        <button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded font-bold hover:bg-red-700">ÙØ¹ÙØ ÙÙØ°</button>
                        <button onClick={onCancel} className="bg-gray-200 text-gray-800 px-4 py-2 rounded font-bold hover:bg-gray-300">Ø¥ÙØºØ§Ø¡</button>
                    </div>
                </div>
            </div>
        );

        function Login({ onLogin }) {
            const [p, setP] = useState('');
            return <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4"><div className="bg-white rounded-2xl p-8 w-full max-w-md text-center"><Icons.Lock size={48} className="mx-auto mb-4 text-slate-700"/><h2 className="text-2xl font-bold mb-6">Cash Count V19</h2><input type="password" value={p} onChange={e=>setP(e.target.value)} className="w-full text-center text-2xl border-2 rounded-lg py-2 mb-4" placeholder="****" autoFocus/><button onClick={()=>p===APP_PIN?onLogin():alert('Ø®Ø·Ø£')} className="w-full bg-slate-800 text-white font-bold py-3 rounded-lg">Ø¯Ø®ÙÙ</button></div></div>;
        }

        function App() {
            const [auth, setAuth] = useState(()=>sessionStorage.getItem('auth')==='1');
            const [view, setView] = useState('calc');
            const [teller, setTeller] = useState(()=>localStorage.getItem('teller_v19')||'');
            const [vault, setVault] = useState(()=>JSON.parse(localStorage.getItem('vault_v19')) || (() => { const v={}; Object.keys(CURRENCIES).forEach(c=>{v[c]={}; CURRENCIES[c].denominations.forEach(d=>v[c][d]=0)}); return v; })());
            const [trans, setTrans] = useState(()=>JSON.parse(localStorage.getItem('trans_v19'))||[]);
            const [editingTrans, setEditingTrans] = useState(null);
            
            // Modal State
            const [modalConfig, setModalConfig] = useState(null); // { message, action }

            const fileRef = useRef(null);

            useEffect(()=>{
                if(auth) {
                    localStorage.setItem('teller_v19', teller);
                    localStorage.setItem('vault_v19', JSON.stringify(vault));
                    localStorage.setItem('trans_v19', JSON.stringify(trans));
                    if(window.lucide) window.lucide.createIcons();
                }
            }, [vault, trans, teller, auth, view]);

            if(!auth) return <Login onLogin={()=>{setAuth(true); sessionStorage.setItem('auth','1')}}/>;

            const getNextId = (list) => list.length === 0 ? 1 : Math.max(...list.map(t => parseInt(t.id) || 0)) + 1;

            const updateVaultBalance = (currentVault, transaction, isReversal) => {
                const newVault = { ...currentVault };
                const cv = newVault[transaction.currency];
                const mult = isReversal ? -1 : 1;
                
                if (transaction.type === 'EXCHANGE') {
                    // EXCHANGE: In=Target (Add), Out=Source (Remove)
                    Object.entries(transaction.cashInBreakdown).forEach(([d, c]) => cv[d] = (cv[d] || 0) + (c * mult));
                    Object.entries(transaction.cashOutBreakdown).forEach(([d, c]) => cv[d] = (cv[d] || 0) - (c * mult));
                } else {
                    // STANDARD: In adds, Out subtracts
                    Object.entries(transaction.cashInBreakdown).forEach(([d, c]) => cv[d] = (cv[d] || 0) + (c * mult));
                    Object.entries(transaction.cashOutBreakdown).forEach(([d, c]) => cv[d] = (cv[d] || 0) - (c * mult));
                }
                return newVault;
            };

            const process = (data) => {
                let newTransList = [...trans];
                let newVault = { ...vault };

                if (editingTrans) {
                    newVault = updateVaultBalance(newVault, editingTrans, true);
                    const auditLog = generateDetailedAudit(editingTrans, data, editingTrans.auditNotes);
                    const updatedT = { 
                        ...data, id: editingTrans.id, date: new Date().toISOString(), tellerName: teller, 
                        originalData: editingTrans.originalData || editingTrans, auditNotes: auditLog 
                    };
                    newVault = updateVaultBalance(newVault, updatedT, false);
                    newTransList = newTransList.map(t => t.id === editingTrans.id ? updatedT : t);
                    setEditingTrans(null);
                    alert("ØªÙ Ø­ÙØ¸ Ø§ÙØªØ¹Ø¯ÙÙ");
                } else {
                    const t = { ...data, id: getNextId(newTransList), date: new Date().toISOString(), tellerName: teller };
                    newVault = updateVaultBalance(newVault, t, false);
                    newTransList = [t, ...newTransList];
                }
                setVault(newVault);
                setTrans(newTransList);
            };

            // VOID
            const requestVoid = (t) => {
                setModalConfig({
                    message: `ÙÙ Ø£ÙØª ÙØªØ£ÙØ¯ ÙÙ Ø¥ÙØºØ§Ø¡ Ø§ÙÙØ¹Ø§ÙÙØ© Ø±ÙÙ ${t.id}Ø\nØ³ÙØªÙ Ø¹ÙØ³ Ø§ÙØªØ£Ø«ÙØ± Ø§ÙÙØ§ÙÙ ÙØªØºÙÙØ± Ø§ÙØ­Ø§ÙØ©.`,
                    action: () => executeVoid(t)
                });
            };

            const executeVoid = (t) => {
                const revertedVault = updateVaultBalance(vault, t, true);
                setVault(revertedVault);
                const updatedList = trans.map(tr => 
                    tr.id === t.id ? { 
                        ...tr, status: 'VOID', voidDate: new Date().toISOString(),
                        auditNotes: tr.auditNotes ? `${tr.auditNotes}\n[${new Date().toLocaleTimeString()}] ØªÙ Ø§ÙØ¥ÙØºØ§Ø¡ (VOID)` : `[${new Date().toLocaleTimeString()}] ØªÙ Ø§ÙØ¥ÙØºØ§Ø¡ (VOID)`
                    } : tr
                );
                setTrans(updatedList);
                setModalConfig(null);
            };

            const backup = () => {
                const b = new Blob([JSON.stringify({vault, trans, teller, date: new Date()})], {type:'application/json'});
                const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`Backup_V19_${teller}.json`; a.click();
            };
            const restore = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader(); r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); if(d.vault && d.trans){ if(confirm('Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ø')) { setVault(d.vault); setTrans(d.trans); if(d.teller) setTeller(d.teller); alert('ØªÙ!'); } } }catch{alert('ÙÙÙ Ø®Ø·Ø£')} }; r.readAsText(f); e.target.value=null;
            };

            return (
                <div className="min-h-screen bg-gray-100 text-gray-900" dir="rtl">
                    {modalConfig && <ConfirmModal message={modalConfig.message} onConfirm={modalConfig.action} onCancel={()=>setModalConfig(null)} />}
                    
                    <nav className="bg-slate-900 text-white shadow sticky top-0 z-40 p-2">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
                            <div className="flex items-center gap-2 font-bold text-xl mb-2 md:mb-0"><Icons.Coins className="text-yellow-500"/> Cash Count</div>
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-800 px-3 py-1 rounded flex items-center gap-2 border border-slate-600">
                                    <Icons.User size={16}/><input value={teller} onChange={e=>setTeller(e.target.value)} placeholder="Ø§Ø³Ù Ø§ÙØªÙÙØ±" className="bg-transparent border-none text-white w-32 focus:outline-none font-bold text-sm"/>
                                </div>
                                <button onClick={()=>{setAuth(false);sessionStorage.removeItem('auth')}} className="text-red-400 text-xs border border-red-900 px-2 py-1 rounded">Ø®Ø±ÙØ¬</button>
                            </div>
                            <div className="flex gap-2 mt-2 md:mt-0">
                                {['calc','multi','vault','hist'].map(v => <button key={v} onClick={()=>{setView(v); setEditingTrans(null)}} className={`px-3 py-1 rounded text-sm font-bold flex gap-1 items-center ${view===v?'bg-yellow-500 text-black':'text-gray-300'}`}>
                                    {v==='calc'?<><Icons.Calculator size={14}/> Ø¹ÙÙÙØ§Øª</>:v==='multi'?<><Icons.Layers size={14}/> Ø¥ÙØ¯Ø§Ø¹Ø§Øª ÙØªØ¹Ø¯Ø¯Ø©</>:v==='vault'?<><Icons.Wallet size={14}/> Ø®Ø²ÙÙØ©</>:<><Icons.RefreshCcw size={14}/> Ø³Ø¬Ù</>}
                                </button>)}
                            </div>
                        </div>
                    </nav>
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="bg-white p-2 rounded shadow mb-4 flex justify-between items-center text-sm">
                            <span className="flex gap-1 text-gray-500"><Icons.AlertTriangle size={16} className="text-yellow-600"/> Ø§Ø­ÙØ¸ Backup ÙÙÙÙØ§Ù</span>
                            <div className="flex gap-2">
                                <button onClick={backup} className="flex gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded border border-blue-200"><Icons.Download size={14}/> Ø­ÙØ¸</button>
                                <button onClick={()=>fileRef.current.click()} className="flex gap-1 px-2 py-1 bg-gray-50 text-gray-700 rounded border border-gray-300"><Icons.Upload size={14}/> Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                                <input type="file" ref={fileRef} onChange={restore} className="hidden"/>
                            </div>
                        </div>
                        {view==='calc' && <Calc onProcess={process} onPrint={d=>openPrint({...d, tellerName: teller})} vault={vault} editingData={editingTrans} cancelEdit={()=>setEditingTrans(null)} setModalConfig={setModalConfig} />}
                        {view==='multi' && <MultiDeposit onProcess={process} onPrint={d=>openPrint({...d, tellerName: teller})} vault={vault} editingData={editingTrans} cancelEdit={()=>setEditingTrans(null)} setModalConfig={setModalConfig} />}
                        {view==='vault' && <Vault vault={vault} onProcess={process} />}
                        {view==='hist' && <Hist trans={trans} onPrint={openPrint} onVoid={requestVoid} onEdit={(t)=>{setEditingTrans(t); setView(t.type==='MULTI'?'multi':'calc')}} />}
                    </main>
                </div>
            );
        }

        // --- 1. Transaction Calc ---
        function Calc({ onProcess, onPrint, vault, editingData, cancelEdit, setModalConfig }) {
            const [curr, setCurr] = useState('EGP');
            const [inp, setInp] = useState({});
            const [out, setOut] = useState({});
            const [chks, setChks] = useState([]);
            const [slips, setSlips] = useState([]);
            const [warnMsg, setWarnMsg] = useState('');

            useEffect(() => {
                if (editingData) {
                    setCurr(editingData.currency); setInp(editingData.cashInBreakdown); setOut(editingData.cashOutBreakdown);
                    setChks(editingData.checks.map((c,i)=>({id:i, a:c.amount}))); setSlips(editingData.deposits.map((d,i)=>({id:i, a:d.amount})));
                } else reset();
            }, [editingData]);

            useEffect(() => {
                let msgs = [];
                Object.entries(out).forEach(([d, amount]) => {
                    const avail = (vault[curr][d] || 0) + (inp[d] || 0);
                    if (amount > avail) msgs.push(`Ø¹Ø¬Ø² ÙØ¦Ø© ${d}`);
                });
                setWarnMsg(msgs.join(', '));
            }, [out, inp, vault, curr]);

            const calc = (obj) => Object.entries(obj).reduce((s,[d,c])=>s+(d*c),0);
            const sum = (arr) => arr.reduce((s,i)=>s+i.a,0);
            const totIn = calc(inp), totOut = calc(out), totChks = sum(chks), totSlips = sum(slips);
            const variance = (totIn + totChks) - totOut - totSlips;

            const reset = () => { setInp({}); setOut({}); setChks([]); setSlips([]); };
            const getPayload = (id) => ({
                id, type: 'CUSTOMER', date: new Date().toISOString(), currency: curr,
                cashInBreakdown: inp, totalCashIn: totIn,
                cashOutBreakdown: out, totalCashOut: totOut,
                checks: chks.map(c=>({amount: c.a})), totalChecks: totChks,
                deposits: slips.map(s=>({amount: s.a})), totalDepositsRequired: totSlips,
                variance, notes: warnMsg
            });

            return (
                <div className="grid lg:grid-cols-12 gap-6 items-start">
                    <div className="lg:col-span-8 space-y-4">
                        <div className={`bg-white p-3 rounded shadow border-t-4 ${editingData ? 'border-orange-500' : 'border-yellow-500'} flex justify-between`}>
                            <h2 className="font-bold text-lg">{editingData ? `ØªØ¹Ø¯ÙÙ #${editingData.id}` : 'Ø¹ÙÙÙØ© Ø¹ÙÙÙ'}</h2>
                            <div className="flex gap-2">
                                {editingData && <button onClick={cancelEdit} className="bg-gray-200 px-3 py-1 rounded text-sm font-bold">Ø¥ÙØºØ§Ø¡</button>}
                                <select value={curr} onChange={e=>{setCurr(e.target.value); reset()}} className="border p-1 rounded font-bold" disabled={!!editingData}>{Object.keys(CURRENCIES).map(c=><option key={c} value={c}>{CURRENCIES[c].name}</option>)}</select>
                            </div>
                        </div>
                        <Denom title="1. ÙÙØ¯ÙØ© ÙØ§Ø±Ø¯Ø© (In)" c={curr} val={inp} set={setInp} clr="blue"/>
                        <List title="2. Ø´ÙÙØ§Øª" items={chks} set={setChks} icon="file-spreadsheet"/>
                        <List title="3. ÙØ³Ø§Ø¦Ù Ø¥ÙØ¯Ø§Ø¹" items={slips} set={setSlips} icon="save" bg="bg-green-50"/>
                        <Denom title="4. ÙÙØ¯ÙØ© Ø®Ø§Ø±Ø¬Ø© (Out)" c={curr} val={out} set={setOut} clr="red" vault={vault} cashIn={inp} />
                    </div>
                    <div className="lg:col-span-4 space-y-3 sticky top-20">
                        <div className="bg-white p-4 rounded shadow text-center">
                            <h3 className="font-bold border-b mb-2">Ø§ÙÙÙØ®Øµ</h3>
                            <div className="flex justify-between text-sm"><span>ÙØ§Ø±Ø¯:</span><b>{fmtNum(totIn)}</b></div>
                            <div className="flex justify-between text-sm"><span>Ø´ÙÙØ§Øª:</span><b>{fmtNum(totChks)}</b></div>
                            <div className="flex justify-between font-bold border-t mt-1 pt-1"><span>Ø§ÙÙØ³ØªÙÙ:</span><span>{fmtNum(totIn+totChks)}</span></div>
                            <div className="flex justify-between text-sm text-blue-600 mt-2"><span>Ø§ÙÙØ·ÙÙØ¨:</span><b>{fmtNum(totSlips)}</b></div>
                            <div className="flex justify-between text-sm text-red-600"><span>Ø§ÙÙØ±ØªØ¬Ø¹:</span><b>{fmtNum(totOut)}</b></div>
                            <hr className="my-2"/>
                            <div className={`text-3xl font-black my-2 ${Math.abs(variance)<0.01?'text-green-600':variance>0?'text-yellow-600':'text-red-600'}`}>{fmtCurr(variance,'')}</div>
                            <div className="font-bold text-sm">{Math.abs(variance)<0.01?'â ÙØªØ·Ø§Ø¨Ù':variance>0?'â ï¸ Ø²ÙØ§Ø¯Ø©':'â Ø¹Ø¬Ø²'}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={()=>onPrint(getPayload('ÙØ³ÙØ¯Ø©'))} className="py-2 bg-gray-600 text-white rounded font-bold flex justify-center gap-1"><Icons.Printer size={18}/> Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button onClick={()=>{setModalConfig({message:"ÙÙ Ø£ÙØª ÙØªØ£ÙØ¯ ÙÙ ØªÙØ±ÙØº Ø§ÙØ¨ÙØ§ÙØ§ØªØ", action: reset})}} className="py-2 bg-red-100 text-red-700 rounded font-bold flex justify-center gap-1"><Icons.Trash2 size={18}/> ØªÙØ±ÙØº</button>
                        </div>
                        <button onClick={()=>{if(!totIn&&!totChks&&!totSlips&&!totOut)return alert('ÙØ§Ø±Øº'); onProcess(getPayload('TEMP')); if(!editingData) reset()}} className={`w-full py-3 ${editingData?'bg-orange-600':'bg-slate-900'} text-white font-bold rounded shadow flex justify-center gap-2`}><Icons.Save size={20}/> {editingData?'Ø­ÙØ¸ Ø§ÙØªØ¹Ø¯ÙÙ':'Ø­ÙØ¸'}</button>
                    </div>
                </div>
            );
        }

        // --- 2. Multi-Deposit View ---
        function MultiDeposit({ onProcess, onPrint, vault, editingData, cancelEdit, setModalConfig }) {
            const [curr, setCurr] = useState('EGP');
            const [inp, setInp] = useState({});
            const [out, setOut] = useState({});
            const [chks, setChks] = useState([]);
            const [slips, setSlips] = useState([]);
            const [warnMsg, setWarnMsg] = useState('');

            useEffect(() => {
                if (editingData) {
                    setCurr(editingData.currency); setInp(editingData.cashInBreakdown); setOut(editingData.cashOutBreakdown);
                    setChks(editingData.checks.map((c,i)=>({id:i, a:c.amount}))); setSlips(editingData.deposits.map((d,i)=>({id:i, a:d.amount})));
                } else reset();
            }, [editingData]);

            const getSystemBreakdown = (amount) => {
                let remaining = Math.round(amount * 100); 
                const breakdown = {};
                SYSTEM_DENOMS.forEach(denom => {
                    const denomInt = Math.round(denom * 100);
                    const count = Math.floor(remaining / denomInt);
                    if (count > 0) {
                        breakdown[denom] = count;
                        remaining -= count * denomInt;
                    }
                });
                return breakdown;
            };

            const calc = (obj) => Object.entries(obj).reduce((s,[d,c])=>s+(d*c),0);
            const sum = (arr) => arr.reduce((s,i)=>s+i.a,0);
            
            const totIn = calc(inp), totOut = calc(out), totChks = sum(chks), totSlips = sum(slips);
            const variance = (totIn + totChks) - totOut - totSlips;

            useEffect(() => {
                let msgs = [];
                Object.entries(out).forEach(([d, amount]) => {
                    const avail = (vault[curr][d] || 0) + (inp[d] || 0);
                    if (amount > avail) msgs.push(`Ø¹Ø¬Ø² ÙØ¦Ø© ${d}`);
                });
                setWarnMsg(msgs.join(', '));
            }, [out, inp, vault, curr]);

            const totalSystemBreakdown = {};
            slips.forEach(s => {
                const bd = getSystemBreakdown(s.a);
                Object.entries(bd).forEach(([d, c]) => totalSystemBreakdown[d] = (totalSystemBreakdown[d] || 0) + c);
            });

            const comparisonData = {};
            Object.entries(inp).forEach(([d,c]) => comparisonData[d] = (comparisonData[d] || 0) + c);
            Object.entries(out).forEach(([d,c]) => comparisonData[d] = (comparisonData[d] || 0) - c);
            Object.entries(totalSystemBreakdown).forEach(([d,c]) => comparisonData[d] = (comparisonData[d] || 0) - c);

            const getPayload = (id) => ({
                id, type: 'MULTI', date: new Date().toISOString(), currency: curr,
                cashInBreakdown: inp, totalCashIn: totIn,
                cashOutBreakdown: out, totalCashOut: totOut,
                checks: chks.map(c=>({amount: c.a})), totalChecks: totChks,
                deposits: slips.map(s=>({amount: s.a})), totalDepositsRequired: totSlips,
                variance, notes: warnMsg,
                systemBreakdown: totalSystemBreakdown
            });

            const reset = () => { setInp({}); setOut({}); setChks([]); setSlips([]); };

            return (
                <div className="grid lg:grid-cols-12 gap-6 items-start">
                    <div className="lg:col-span-8 space-y-4">
                        <div className={`bg-white p-3 rounded shadow border-t-4 border-purple-500 flex justify-between`}>
                            <h2 className="font-bold text-lg">{editingData ? `ØªØ¹Ø¯ÙÙ Ø¥ÙØ¯Ø§Ø¹Ø§Øª ÙØªØ¹Ø¯Ø¯Ø© #${editingData.id}` : 'Ø¥ÙØ¯Ø§Ø¹Ø§Øª ÙØªØ¹Ø¯Ø¯Ø©'}</h2>
                            <div className="flex gap-2">
                                {editingData && <button onClick={cancelEdit} className="bg-gray-200 px-3 py-1 rounded text-sm font-bold">Ø¥ÙØºØ§Ø¡</button>}
                                <select value={curr} onChange={e=>{setCurr(e.target.value); reset()}} className="border p-1 rounded font-bold" disabled={!!editingData}>{Object.keys(CURRENCIES).map(c=><option key={c} value={c}>{CURRENCIES[c].name}</option>)}</select>
                            </div>
                        </div>
                        
                        <Denom title="1. ÙÙØ¯ÙØ© ÙØ³ØªÙÙØ© ÙØ¹ÙÙØ§Ù (Physical In)" c={curr} val={inp} set={setInp} clr="blue"/>
                        <List title="2. Ø´ÙÙØ§Øª" items={chks} set={setChks} icon="file-spreadsheet"/>
                        
                        <div className="bg-white p-3 rounded shadow border border-purple-200">
                            <List title="3. ÙØ³Ø§Ø¦Ù Ø§ÙØ¥ÙØ¯Ø§Ø¹ (Values)" items={slips} set={setSlips} icon="layers" bg="bg-purple-50"/>
                            {slips.length > 0 && (
                                <div className="mt-2 space-y-2">
                                    {slips.map((s, idx) => (
                                        <div key={s.id} className="text-xs bg-gray-50 p-2 rounded border flex justify-between items-center">
                                            <span className="font-bold text-purple-700">Ø¥ÙØ¯Ø§Ø¹ #{idx+1}: {fmtNum(s.a)}</span>
                                            <div className="flex flex-wrap gap-1">
                                                {sortDenoms(getSystemBreakdown(s.a)).map(([d,c]) => (
                                                    <span key={d} className="bg-white border px-1 rounded shadow-sm">{d}: <b>{c}</b></span>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <Denom title="4. ÙÙØ¯ÙØ© Ø®Ø§Ø±Ø¬Ø© (Physical Out)" c={curr} val={out} set={setOut} clr="red" vault={vault} cashIn={inp}/>
                        
                        {totIn > 0 && totSlips > 0 && (
                            <div className="bg-white p-3 rounded shadow border-t-4 border-gray-500">
                                <h3 className="font-bold text-sm mb-2 text-indigo-700">Ø¬Ø¯ÙÙ ØªØ³ÙÙØ© Ø§ÙÙØ¦Ø§Øª (Ø§ÙØµØ§ÙÙ Ø§ÙÙØ¹ÙÙ ÙØ¹ Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø§Øª Ø§ÙØ´ÙÙ Ø§ÙÙØ®ØµÙÙØ©)</h3>
                                <table className="w-full text-center text-xs border">
                                    <thead className="bg-gray-100"><tr><th>Ø§ÙÙØ¦Ø©</th><th>Ø§ÙÙØ±Ù (Action)</th></tr></thead>
                                    <tbody>
                                        {sortDenoms(comparisonData).map(([d, diff]) => {
                                            if (diff === 0) return null;
                                            return <tr key={d} className="border-t">
                                                <td className="font-bold">{d}</td>
                                                <td className={`font-bold ${diff<0?'text-red-600':'text-green-600'}`}>{diff > 0 ? `+${diff} (ÙØ§Ø¦Ø¶ ÙØ¹Ù)` : `${diff} (Ø¹Ø¬Ø²/ÙØ·ÙÙØ¨)`}</td>
                                            </tr>
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    <div className="lg:col-span-4 space-y-3 sticky top-20">
                        <div className="bg-white p-4 rounded shadow text-center">
                            <h3 className="font-bold border-b mb-2">ÙÙØ®Øµ Ø§ÙØ¹ÙÙÙØ©</h3>
                            <div className="flex justify-between text-sm"><span>Ø¥Ø¬ÙØ§ÙÙ Ø§ÙÙØ¹ÙÙ (In):</span><b>{fmtNum(totIn)}</b></div>
                            <div className="flex justify-between text-sm"><span>Ø¥Ø¬ÙØ§ÙÙ Ø§ÙØ¥ÙØ¯Ø§Ø¹Ø§Øª:</span><b>{fmtNum(totSlips)}</b></div>
                            <div className="flex justify-between text-sm text-red-600"><span>Ø§ÙÙØ±ØªØ¬Ø¹ (Out):</span><b>{fmtNum(totOut)}</b></div>
                            <hr className="my-2"/>
                            <div className={`text-3xl font-black my-2 ${Math.abs(variance)<0.01?'text-green-600':variance>0?'text-yellow-600':'text-red-600'}`}>{fmtCurr(variance,'')}</div>
                            <div className="font-bold text-sm">{Math.abs(variance)<0.01?'â ÙØªØ·Ø§Ø¨Ù':variance>0?'â ï¸ Ø²ÙØ§Ø¯Ø©':'â Ø¹Ø¬Ø²'}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={()=>onPrint(getPayload('ÙØ³ÙØ¯Ø©'))} className="py-2 bg-gray-600 text-white rounded font-bold flex justify-center gap-1"><Icons.Printer size={18}/> Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button onClick={()=>{setModalConfig({message:"ÙÙ Ø£ÙØª ÙØªØ£ÙØ¯ ÙÙ ØªÙØ±ÙØº Ø§ÙØ¨ÙØ§ÙØ§ØªØ", action: reset})}} className="py-2 bg-red-100 text-red-700 rounded font-bold flex justify-center gap-1"><Icons.Trash2 size={18}/> ØªÙØ±ÙØº</button>
                        </div>
                        <button onClick={()=>{
                            if(!totIn&&!totChks&&!totSlips&&!totOut)return alert('ÙØ§Ø±Øº'); 
                            onProcess(getPayload('TEMP')); 
                            if(!editingData) reset();
                        }} className="w-full py-3 bg-purple-600 text-white font-bold rounded shadow flex justify-center gap-2"><Icons.Save size={20}/> {editingData?'Ø­ÙØ¸ Ø§ÙØªØ¹Ø¯ÙÙ':'Ø­ÙØ¸'}</button>
                    </div>
                </div>
            );
        }

        // --- 3. Vault View ---
        function Vault({ vault, onProcess }) {
            const [c, setC] = useState('EGP');
            const [mode, setMode] = useState(null); 
            const [temp, setTemp] = useState({}); 
            const [exSource, setExSource] = useState({});
            const [exTarget, setExTarget] = useState({});
            
            const curTot = Object.entries(vault[c]||{}).reduce((s,[d,cnt])=>s+(d*cnt),0);
            
            const commit = () => {
                if (mode === 'EXCHANGE') {
                    const srcTot = Object.entries(exSource).reduce((s,[d,c])=>s+(d*c),0);
                    const tgtTot = Object.entries(exTarget).reduce((s,[d,c])=>s+(d*c),0);
                    if(Math.abs(srcTot - tgtTot) > 0.01) return alert(`Ø®Ø·Ø£: Ø§ÙÙÙÙ ØºÙØ± ÙØªØ³Ø§ÙÙØ©`);
                    
                    for (const [d, count] of Object.entries(exSource)) {
                        if (count > (vault[c][d] || 0)) return alert(`Ø¹ÙÙØ§ÙØ Ø±ØµÙØ¯ ÙØ¦Ø© ${d} ØºÙØ± ÙØ§ÙÙ`);
                    }

                    onProcess({
                        type: 'EXCHANGE', currency: c,
                        // Exchange Logic: Source (Out), Target (In)
                        cashInBreakdown: exTarget, totalCashIn: tgtTot, 
                        cashOutBreakdown: exSource, totalCashOut: srcTot, 
                        checks:[], totalChecks:0, deposits:[], totalDepositsRequired:0, variance:0
                    });
                    alert("ØªÙ ØªØºÙÙØ± Ø§ÙÙØ¦Ø§Øª Ø¨ÙØ¬Ø§Ø­");
                } else {
                    onProcess({
                        type: mode, currency: c,
                        cashInBreakdown: mode==='CASH_IN'?temp:{}, totalCashIn: mode==='CASH_IN'?Object.entries(temp).reduce((s,[d,c])=>s+(d*c),0):0,
                        cashOutBreakdown: mode==='CASH_OUT'?temp:{}, totalCashOut: mode==='CASH_OUT'?Object.entries(temp).reduce((s,[d,c])=>s+(d*c),0):0,
                        checks:[], totalChecks:0, deposits:[], totalDepositsRequired:0, variance:0
                    });
                    alert("ØªÙØª Ø§ÙØ¹ÙÙÙØ©");
                }
                setMode(null); setTemp({}); setExSource({}); setExTarget({});
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex flex-wrap justify-between items-center gap-2">
                        <h2 className="font-bold text-lg">Ø§ÙØ®Ø²ÙÙØ©</h2>
                        <div className="flex gap-2 flex-wrap">
                            <select value={c} onChange={e=>setC(e.target.value)} className="border p-1 rounded font-bold">{Object.keys(CURRENCIES).map(k=><option key={k} value={k}>{CURRENCIES[k].name}</option>)}</select>
                            <button onClick={()=>{setMode('CASH_IN');setTemp({})}} className="bg-green-600 text-white px-3 py-1 rounded font-bold text-sm flex gap-1"><Icons.ArrowDown size={16}/> Cash In</button>
                            <button onClick={()=>{setMode('CASH_OUT');setTemp({})}} className="bg-orange-600 text-white px-3 py-1 rounded font-bold text-sm flex gap-1"><Icons.ArrowUp size={16}/> Cash Out</button>
                            <button onClick={()=>{setMode('EXCHANGE');setExSource({});setExTarget({})}} className="bg-blue-600 text-white px-3 py-1 rounded font-bold text-sm flex gap-1"><Icons.RefreshCw size={16}/> Exchange</button>
                        </div>
                    </div>
                    <div className="grid md:grid-cols-2 gap-4">
                        <div className="bg-white rounded shadow overflow-hidden">
                            <table className="w-full text-center text-sm">
                                <thead className="bg-slate-800 text-white"><tr><th>Ø§ÙÙØ¦Ø©</th><th>Ø§ÙØ¹Ø¯Ø¯</th><th>Ø§ÙÙÙÙØ©</th></tr></thead>
                                <tbody>{sortDenoms(CURRENCIES[c].denominations.reduce((acc, d) => ({...acc, [d]: 0}), {})).map(([d])=><tr key={d} className="border-b"><td className="font-bold">{d}</td><td>{fmtNum(vault[c][d]||0)}</td><td className="text-gray-500">{fmtNum((vault[c][d]||0)*d)}</td></tr>)}</tbody>
                                <tfoot className="bg-gray-100 font-bold"><tr><td colSpan="2">Ø§ÙØ¥Ø¬ÙØ§ÙÙ</td><td className="text-blue-700">{fmtCurr(curTot,c)}</td></tr></tfoot>
                            </table>
                        </div>
                        <div className="bg-blue-50 p-6 rounded border border-blue-200 h-fit"><h3 className="font-bold text-blue-900 mb-2">Ø§ÙØ±ØµÙØ¯ Ø§ÙÙØ¹ÙÙ</h3><div className="text-3xl font-bold text-blue-700">{fmtCurr(curTot,c)}</div></div>
                    </div>
                    
                    {mode && <div className="fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4">
                        <div className="bg-white w-full max-w-lg rounded shadow-lg overflow-hidden">
                            <div className="bg-slate-800 text-white p-3 font-bold flex justify-between"><span>{mode} - {c}</span><button onClick={()=>setMode(null)}><Icons.X/></button></div>
                            <div className="max-h-[70vh] overflow-y-auto p-4">
                                {mode === 'EXCHANGE' ? <div className="grid grid-cols-2 gap-4">
                                    <div><h4 className="text-center border-b mb-2 text-red-600 font-bold">ÙÙ (Source/Out)</h4><Denom title="" c={c} val={exSource} set={setExSource} clr="red" simple={true}/><div className="text-center font-bold"></div></div>
                                    <div><h4 className="text-center border-b mb-2 text-green-600 font-bold">Ø¥ÙÙ (Target/In)</h4><Denom title="" c={c} val={exTarget} set={setExTarget} clr="green" simple={true}/><div className="text-center font-bold"></div></div>
                                </div> : <Denom title="" c={c} val={temp} set={setTemp} clr={mode==='CASH_IN'?'green':'orange'} simple={true}/>}
                            </div>
                            <div className="bg-gray-100 p-3 flex justify-between items-center">
                                <button onClick={commit} className="px-4 py-2 bg-slate-800 text-white font-bold rounded">ØªØ£ÙÙØ¯</button>
                            </div>
                        </div>
                    </div>}
                </div>
            );
        }

        // --- 4. History View ---
        function Hist({ trans, onPrint, onVoid, onEdit }) {
            const exp = () => {
                if(!trans.length) return;
                let csv = "\uFEFFID,Status,Type,Teller,Date,Currency,In,Details In,Checks,Slips,Out,Details Out,Variance,Notes,Audit_History\n";
                trans.forEach(t => {
                    const di = sortDenoms(t.cashInBreakdown).filter(x=>x[1]>0).map(x=>`${x[0]}x${x[1]}`).join("|");
                    const do_ = sortDenoms(t.cashOutBreakdown).filter(x=>x[1]>0).map(x=>`${x[0]}x${x[1]}`).join("|");
                    const chks = t.checks?.map((c,i)=>`C${i+1}:${c.amount}`).join("|")||"";
                    const slps = t.deposits?.map((d,i)=>`S${i+1}:${d.amount}`).join("|")||"";
                    let note = t.notes || ""; if(t.status==='VOID') note+=" [VOIDED]"; 
                    // Replace newlines in Audit Log for CSV safety
                    const auditClean = (t.auditNotes || '').replace(/\n/g, " | ");
                    csv += `"${t.id}",${t.status||'OK'},${t.type},"${t.tellerName}","${fmtDate(t.date)}",${t.currency},${t.totalCashIn},"${di}",${t.totalChecks}[${chks}],${t.totalDepositsRequired}[${slps}],${t.totalCashOut},"${do_}",${t.variance},"${note}","${auditClean}"\n`;
                });
                const a = document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="Report.csv"; a.click();
            };
            return (
                <div className="space-y-4">
                    <div className="flex justify-between bg-white p-3 rounded shadow"><h2 className="font-bold text-lg">Ø§ÙØ³Ø¬Ù</h2><button onClick={exp} className="bg-green-600 text-white px-3 py-1 rounded font-bold text-sm flex gap-1"><Icons.FileSpreadsheet size={16}/> Excel</button></div>
                    <div className="bg-white rounded shadow overflow-x-auto">
                        <table className="w-full text-right whitespace-nowrap text-sm">
                            <thead className="bg-gray-100"><tr><th className="p-2">#</th><th className="p-2">ÙÙØ¹</th><th className="p-2">ØªÙÙØ±</th><th className="p-2">ØªØ§Ø±ÙØ®</th><th className="p-2">In</th><th className="p-2">Out</th><th className="p-2">ÙÙØ§Ø­Ø¸Ø§Øª</th><th className="p-2">Ø³Ø¬Ù Ø§ÙØªØ¹Ø¯ÙÙØ§Øª</th><th className="p-2"></th></tr></thead>
                            <tbody>{trans.map(t=><tr key={t.id} className={`border-b ${t.status==='VOID'?'bg-red-50 opacity-60':''}`}>
                                <td className="p-2 font-mono">{t.id}</td>
                                <td className="p-2 text-xs font-bold">{t.type} {t.auditNotes?<span className="text-blue-600 block">(ÙØ¹Ø¯Ù)</span>:''}</td>
                                <td className="p-2">{t.tellerName}</td><td className="p-2">{fmtDate(t.date)}</td>
                                <td className="p-2 text-green-700 font-bold">{t.totalCashIn>0?fmtNum(t.totalCashIn):'-'}</td>
                                <td className="p-2 text-red-700 font-bold">{t.totalCashOut>0?fmtNum(t.totalCashOut):'-'}</td>
                                <td className="p-2 text-xs max-w-[150px] truncate">
                                    {t.notes && <span className="text-red-500 block">{t.notes}</span>}
                                    {t.status==='VOID' && <span className="text-red-600 font-bold">ÙÙØºØ§Ø©</span>}
                                </td>
                                <td className="p-2 audit-log max-w-[300px]">{t.auditNotes || '-'}</td>
                                <td className="p-2 flex gap-1">
                                    <button onClick={()=>onPrint(t)} className="bg-gray-100 p-1 rounded hover:bg-gray-200"><Icons.Printer size={16}/></button>
                                    {t.status!=='VOID' && <><button onClick={()=>onEdit(t)} className="bg-blue-100 text-blue-700 p-1 rounded"><Icons.Edit size={16}/></button><button onClick={()=>onVoid(t)} className="bg-red-100 text-red-700 p-1 rounded"><Icons.Ban size={16}/></button></>}
                                </td>
                            </tr>)}</tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- Helpers ---
        const Denom = ({ title, c, val, set, clr, simple, vault, cashIn }) => {
            const tot = Object.entries(val).reduce((s,[d,count])=>s+(d*count),0);
            return (
                <div className={!simple?`bg-white rounded shadow border-t-4 border-${clr}-500`:''}>
                    {!simple && <div className="bg-gray-50 p-2 flex justify-between border-b"><h3 className={`font-bold text-${clr}-700`}>{title}</h3><span className="font-bold">{fmtCurr(tot,c)}</span></div>}
                    <div className={simple?"p-0":"p-2"}>
                        {sortDenoms(CURRENCIES[c].denominations.reduce((acc, d) => ({...acc, [d]: 0}), {})).map(([dStr])=>{
                            const d = parseFloat(dStr);
                            const amount = val[d] || 0;
                            let isError = false;
                            if (!simple && clr === 'red' && amount > 0 && vault && cashIn) {
                                const avail = (vault[c][d] || 0) + (cashIn[d] || 0);
                                if (amount > avail) isError = true;
                            }
                            return (
                                <div key={d} className="flex items-center border-b last:border-0 py-1 text-sm">
                                    <span className="w-12 font-bold">{d}</span>
                                    <div className="flex items-center flex-1 mx-2 relative">
                                        <input type="number" min="0" placeholder="0" className={`flex-1 w-full text-center border rounded font-bold py-1 ${isError?'error-glow text-red-600':''}`}
                                            value={val[d]||''} onChange={e=>{
                                                const nv = parseFloat(e.target.value);
                                                const newVal = {...val};
                                                if(nv>0) newVal[d]=nv; else delete newVal[d];
                                                set(newVal);
                                            }} onFocus={e=>e.target.select()}
                                        />
                                        {val[d] && <button onClick={()=>{const n={...val}; delete n[d]; set(n)}} className="absolute left-1 top-1 text-gray-400 hover:text-red-500"><Icons.XCircle size={16}/></button>}
                                    </div>
                                    <span className="w-20 text-left text-gray-500 font-mono">{val[d]>0?fmtNum(val[d]*d):'-'}</span>
                                    {isError && <span className="text-[10px] text-red-500 absolute left-20 bg-white px-1 border border-red-200">ØºÙØ± ÙØªÙÙØ±!</span>}
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        const List = ({ title, items, set, icon, bg="bg-white" }) => {
            const [v, SV] = useState('');
            const add = () => { if(v){ set([...items,{id:Date.now(), a:parseFloat(v)}]); SV(''); }};
            const tot = items.reduce((s,i)=>s+i.a,0);
            return (
                <div className={`${bg} p-3 rounded shadow border border-gray-200`}>
                    <div className="flex justify-between mb-2 text-sm"><div className="flex gap-1 font-bold text-gray-700"><Icon name={icon} size={16}/>{title}</div><span className="bg-white px-1 border rounded font-mono">{fmtNum(tot)}</span></div>
                    <div className="flex gap-1 mb-2">
                        <div className="relative flex-1">
                            <input type="number" className="w-full border rounded p-1 text-sm pr-6" value={v} onChange={e=>SV(e.target.value)} onKeyDown={e=>e.key==='Enter'&&add()} placeholder="Ø§ÙÙÙÙØ©" />
                            {v && <button onClick={()=>SV('')} className="absolute top-1 left-1 text-gray-400 hover:text-red-500"><Icons.XCircle size={16}/></button>}
                        </div>
                        <button onClick={add} className="bg-slate-700 text-white px-2 rounded"><Icons.Plus size={16}/></button>
                    </div>
                    <ul className="max-h-24 overflow-y-auto space-y-1">{items.map((i,idx)=><li key={i.id} className="flex justify-between bg-white px-2 py-1 border rounded text-xs"><span>#{idx+1}: <b>{fmtNum(i.a)}</b></span><button onClick={()=>set(items.filter(x=>x.id!==i.id))} className="text-red-500 hover:text-red-700 bg-red-50 p-1 rounded"><Icons.Trash2 size={16}/></button></li>)}</ul>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

